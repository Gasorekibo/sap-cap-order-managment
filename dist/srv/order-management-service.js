"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
async function default_1(srv) {
    // Add a very visible log message to confirm the service is loading
    console.log("========================================");
    console.log("ORDER MANAGEMENT SERVICE IS INITIALIZING");
    console.log("========================================");
    const { Orders, OrderItems, Products, Customers } = srv.entities;
    srv.before("CREATE", Products, async (req) => {
        if (!req.data.name || !req.data.price || !req.data.stockQuantity) {
            req.error(400, "Name, price, and stock quantity are required");
            return;
        }
        if (req.data.price < 0) {
            req.error(400, "Price cannot be negative");
            return;
        }
        if (req.data.stockQuantity < 0) {
            req.error(400, "Stock quantity cannot be negative");
            return;
        }
        const existingProduct = await srv.tx(req).run(SELECT.one.from(Products).where({ name: req.data.name }));
        if (existingProduct) {
            req.error(400, `Product with name ${req.data.name} already exists`);
            return;
        }
    });
    srv.before("CREATE", Customers, async (req) => {
        if (!req.data.firstName || !req.data.email || !req.data.lastName) {
            req.error(400, "Name and email are required");
            return;
        }
        const existingCustomer = await srv.tx(req).run(SELECT.one.from(Customers).where({ email: req.data.email }));
        if (existingCustomer) {
            req.error(400, `Customer with email ${req.data.email} already exists`);
            return;
        }
    });
    srv.before("CREATE", Orders, async (req) => {
        if (!req.data.customer_ID) {
            req.error(400, "Customer ID is required");
            return;
        }
        const customer = await srv.tx(req).run(SELECT.one.from(Customers).where({ ID: req.data.customer_ID }));
        if (!customer) {
            req.error(404, `Customer with ID ${req.data.customer_ID} not found`);
            return;
        }
        if (!req.data.items || !Array.isArray(req.data.items) || req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        let totalOrderAmount = 0;
        const processedItems = [];
        try {
            const productPromises = req.data.items.map(async (orderItem) => {
                if (!orderItem.product_ID || !orderItem.quantity) {
                    throw new Error("Product ID and quantity are required for all order items");
                }
                const product = await srv.tx(req).run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                if (!product) {
                    throw new Error(`Product with ID ${orderItem.product_ID} not found`);
                }
                if (product.stockQuantity < orderItem.quantity) {
                    throw new Error(`Not enough stock available for product ${product.name}. Requested: ${orderItem.quantity}, Available: ${product.stockQuantity}`);
                }
                const itemTotalPrice = product.price * orderItem.quantity;
                totalOrderAmount += itemTotalPrice;
                return {
                    original: orderItem,
                    product: product,
                    unitPrice: product.price,
                    totalPrice: itemTotalPrice
                };
            });
            const validatedItems = await Promise.all(productPromises);
            for (const item of validatedItems) {
                // Update product stock
                await srv.tx(req).run(UPDATE(Products)
                    .where({ ID: item.original.product_ID })
                    .set({
                    stockQuantity: { "-=": item.original.quantity }
                }));
                item.original.unitPrice = item.unitPrice;
                item.original.totalPrice = item.totalPrice;
            }
            req.data.totalAmount = totalOrderAmount;
        }
        catch (error) {
            req.error(400, error.message);
            return;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3J2L29yZGVyLW1hbmFnZW1lbnQtc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDRCQXdIQztBQXhIYyxLQUFLLG9CQUFXLEdBQU87SUFFbkMsbUVBQW1FO0lBQ25FLE9BQU8sQ0FBQyxHQUFHLENBQUMsMENBQTBDLENBQUMsQ0FBQztJQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFDeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0lBR3hELE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDO0lBQ2pFLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsR0FBVyxFQUFFLEVBQUU7UUFDbEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ2pFLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLDhDQUE4QyxDQUFDLENBQUM7WUFDL0QsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLDBCQUEwQixDQUFDLENBQUM7WUFDM0MsT0FBTztRQUNULENBQUM7UUFDRCxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQy9CLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLG1DQUFtQyxDQUFDLENB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LE1BQU0sY0FBYyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUUxRCxLQUFLLE1BQU0sSUFBSSxJQUFJLGNBQWMsRUFBRSxDQUFDO2dCQUNsQyx1QkFBdUI7Z0JBQ3ZCLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQ25CLE1BQU0sQ0FBQyxRQUFRLENBQUM7cUJBQ2IsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUM7cUJBQ3ZDLEdBQUcsQ0FBQztvQkFDSCxhQUFhLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUU7aUJBQ2hELENBQUMsQ0FDTCxDQUFDO2dCQUVGLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7WUFDN0MsQ0FBQztZQUVELEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLGdCQUFnQixDQUFDO1FBQzFDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlCLE9BQU87UUFDVCxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7UmVxdWVzdH0gZnJvbSAnQHNhcC9jZHMnXHJcbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIChzcnY6YW55KSB7XHJcblxyXG4gICAvLyBBZGQgYSB2ZXJ5IHZpc2libGUgbG9nIG1lc3NhZ2UgdG8gY29uZmlybSB0aGUgc2VydmljZSBpcyBsb2FkaW5nXHJcbiAgIGNvbnNvbGUubG9nKFwiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVwiKTtcclxuICAgY29uc29sZS5sb2coXCJPUkRFUiBNQU5BR0VNRU5UIFNFUlZJQ0UgSVMgSU5JVElBTElaSU5HXCIpO1xyXG4gICBjb25zb2xlLmxvZyhcIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cIik7XHJcbiAgIFxyXG4gIFxyXG4gICBjb25zdCB7IE9yZGVycywgT3JkZXJJdGVtcywgUHJvZHVjdHMsIEN1c3RvbWVycyB9ID0gc3J2LmVudGl0aWVzO1xyXG4gICBzcnYuYmVmb3JlKFwiQ1JFQVRFXCIsIFByb2R1Y3RzLCBhc3luYyAocmVxOlJlcXVlc3QpID0+IHtcclxuICAgICAgaWYgKCFyZXEuZGF0YS5uYW1lIHx8ICFyZXEuZGF0YS5wcmljZSB8fCAhcmVxLmRhdGEuc3RvY2tRdWFudGl0eSkge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIFwiTmFtZSwgcHJpY2UsIGFuZCBzdG9jayBxdWFudGl0eSBhcmUgcmVxdWlyZWRcIik7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChyZXEuZGF0YS5wcmljZSA8IDApIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBcIlByaWNlIGNhbm5vdCBiZSBuZWdhdGl2ZVwiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHJlcS5kYXRhLnN0b2NrUXVhbnRpdHkgPCAwKSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgXCJTdG9jayBxdWFudGl0eSBjYW5ub3QgYmUgbmVnYXRpdmVcIik7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nUHJvZHVjdCA9IGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICBTRUxFQ1Qub25lLmZyb20oUHJvZHVjdHMpLndoZXJlKHsgbmFtZTogcmVxLmRhdGEubmFtZSB9KVxyXG4gICAgICApO1xyXG4gICAgICBpZiAoZXhpc3RpbmdQcm9kdWN0KSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgYFByb2R1Y3Qgd2l0aCBuYW1lICR7cmVxLmRhdGEubmFtZX0gYWxyZWFkeSBleGlzdHNgKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgIH0pXHJcblxyXG4gICBzcnYuYmVmb3JlKFwiQ1JFQVRFXCIsIEN1c3RvbWVycywgYXN5bmMgKHJlcTpSZXF1ZXN0KSA9PiB7XHJcbiAgICAgIGlmICghcmVxLmRhdGEuZmlyc3ROYW1lIHx8ICFyZXEuZGF0YS5lbWFpbCB8fCAhcmVxLmRhdGEubGFzdE5hbWUpIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBcIk5hbWUgYW5kIGVtYWlsIGFyZSByZXF1aXJlZFwiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgZXhpc3RpbmdDdXN0b21lciA9IGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICBTRUxFQ1Qub25lLmZyb20oQ3VzdG9tZXJzKS53aGVyZSh7IGVtYWlsOiByZXEuZGF0YS5lbWFpbCB9KVxyXG4gICAgICApO1xyXG4gICAgICBpZiAoZXhpc3RpbmdDdXN0b21lcikge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIGBDdXN0b21lciB3aXRoIGVtYWlsICR7cmVxLmRhdGEuZW1haWx9IGFscmVhZHkgZXhpc3RzYCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgIH0pXHJcblxyXG4gICBzcnYuYmVmb3JlKFwiQ1JFQVRFXCIsIE9yZGVycywgYXN5bmMgKHJlcTogUmVxdWVzdCkgPT4ge1xyXG4gICAgaWYgKCFyZXEuZGF0YS5jdXN0b21lcl9JRCkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBcIkN1c3RvbWVyIElEIGlzIHJlcXVpcmVkXCIpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IGN1c3RvbWVyID0gYXdhaXQgc3J2LnR4KHJlcSkucnVuKFxyXG4gICAgICBTRUxFQ1Qub25lLmZyb20oQ3VzdG9tZXJzKS53aGVyZSh7IElEOiByZXEuZGF0YS5jdXN0b21lcl9JRCB9KVxyXG4gICAgKTtcclxuICAgIFxyXG4gICAgaWYgKCFjdXN0b21lcikge1xyXG4gICAgICByZXEuZXJyb3IoNDA0LCBgQ3VzdG9tZXIgd2l0aCBJRCAke3JlcS5kYXRhLmN1c3RvbWVyX0lEfSBub3QgZm91bmRgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgaWYgKCFyZXEuZGF0YS5pdGVtcyB8fCAhQXJyYXkuaXNBcnJheShyZXEuZGF0YS5pdGVtcykgfHwgcmVxLmRhdGEuaXRlbXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDAsIFwiT3JkZXIgbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBpdGVtXCIpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgXHJcbiAgICBsZXQgdG90YWxPcmRlckFtb3VudCA9IDA7XHJcbiAgICBjb25zdCBwcm9jZXNzZWRJdGVtcyA9IFtdO1xyXG4gIFxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcHJvZHVjdFByb21pc2VzID0gcmVxLmRhdGEuaXRlbXMubWFwKGFzeW5jIChvcmRlckl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghb3JkZXJJdGVtLnByb2R1Y3RfSUQgfHwgIW9yZGVySXRlbS5xdWFudGl0eSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUHJvZHVjdCBJRCBhbmQgcXVhbnRpdHkgYXJlIHJlcXVpcmVkIGZvciBhbGwgb3JkZXIgaXRlbXNcIik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgICAgICBTRUxFQ1Qub25lLmZyb20oUHJvZHVjdHMpLndoZXJlKHsgSUQ6IG9yZGVySXRlbS5wcm9kdWN0X0lEIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAoIXByb2R1Y3QpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvZHVjdCB3aXRoIElEICR7b3JkZXJJdGVtLnByb2R1Y3RfSUR9IG5vdCBmb3VuZGApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBpZiAocHJvZHVjdC5zdG9ja1F1YW50aXR5IDwgb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBlbm91Z2ggc3RvY2sgYXZhaWxhYmxlIGZvciBwcm9kdWN0ICR7cHJvZHVjdC5uYW1lfS4gUmVxdWVzdGVkOiAke29yZGVySXRlbS5xdWFudGl0eX0sIEF2YWlsYWJsZTogJHtwcm9kdWN0LnN0b2NrUXVhbnRpdHl9YCk7XHJcbiAgICAgICAgfVxyXG4gIFxyXG4gICAgICAgIGNvbnN0IGl0ZW1Ub3RhbFByaWNlID0gcHJvZHVjdC5wcmljZSAqIG9yZGVySXRlbS5xdWFudGl0eTtcclxuICAgICAgICB0b3RhbE9yZGVyQW1vdW50ICs9IGl0ZW1Ub3RhbFByaWNlO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBvcmlnaW5hbDogb3JkZXJJdGVtLFxyXG4gICAgICAgICAgcHJvZHVjdDogcHJvZHVjdCxcclxuICAgICAgICAgIHVuaXRQcmljZTogcHJvZHVjdC5wcmljZSxcclxuICAgICAgICAgIHRvdGFsUHJpY2U6IGl0ZW1Ub3RhbFByaWNlXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCB2YWxpZGF0ZWRJdGVtcyA9IGF3YWl0IFByb21pc2UuYWxsKHByb2R1Y3RQcm9taXNlcyk7XHJcbiAgICAgIFxyXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsaWRhdGVkSXRlbXMpIHtcclxuICAgICAgICAvLyBVcGRhdGUgcHJvZHVjdCBzdG9ja1xyXG4gICAgICAgIGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICAgIFVQREFURShQcm9kdWN0cylcclxuICAgICAgICAgICAgLndoZXJlKHsgSUQ6IGl0ZW0ub3JpZ2luYWwucHJvZHVjdF9JRCB9KVxyXG4gICAgICAgICAgICAuc2V0KHtcclxuICAgICAgICAgICAgICBzdG9ja1F1YW50aXR5OiB7IFwiLT1cIjogaXRlbS5vcmlnaW5hbC5xdWFudGl0eSB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICBcclxuICAgICAgICBpdGVtLm9yaWdpbmFsLnVuaXRQcmljZSA9IGl0ZW0udW5pdFByaWNlO1xyXG4gICAgICAgIGl0ZW0ub3JpZ2luYWwudG90YWxQcmljZSA9IGl0ZW0udG90YWxQcmljZTtcclxuICAgICAgfVxyXG4gICAgICBcclxuICAgICAgcmVxLmRhdGEudG90YWxBbW91bnQgPSB0b3RhbE9yZGVyQW1vdW50O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuIl19