"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
const cds_1 = __importDefault(require("@sap/cds"));
const { SELECT, UPDATE } = cds_1.default.ql;
async function default_1(srv) {
    const { Orders, Products, Customers } = srv.entities;
    srv.before("CREATE", Products, async (req) => {
        if (!req.data.name || !req.data.price || !req.data.stockQuantity) {
            req.error(400, "Name, price, and stock quantity are required, if they exist their value should be greater than 0");
            return;
        }
        const existingProduct = await srv
            .tx(req)
            .run(SELECT.one.from(Products).where({ name: req.data.name }));
        if (existingProduct) {
            req.error(400, `Product with name ${req.data.name} already exists`);
            return;
        }
    });
    srv.before("CREATE", Customers, async (req) => {
        if (!req.data.firstName || !req.data.email || !req.data.lastName) {
            req.error(400, "Name and email are required");
            return;
        }
        const existingCustomer = await srv
            .tx(req)
            .run(SELECT.one.from(Customers).where({ email: req.data.email }));
        if (existingCustomer) {
            req.error(400, `Customer with email ${req.data.email} already exists`);
            return;
        }
    });
    srv.before("CREATE", Orders, async (req) => {
        if (!req.data.customer_ID) {
            req.error(400, "Customer ID is required");
            return;
        }
        const customer = await srv
            .tx(req)
            .run(SELECT.one.from(Customers).where({ ID: req.data.customer_ID }));
        if (!customer) {
            req.error(404, `Customer with ID ${req.data.customer_ID} not found`);
            return;
        }
        if (!req.data.items ||
            !Array.isArray(req.data.items) ||
            req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        let totalOrderAmount = 0;
        const processedItems = [];
        try {
            const productPromises = req.data.items.map(async (orderItem) => {
                if (!orderItem.product_ID || !orderItem.quantity) {
                    throw new Error("Product ID and quantity are required for all order items");
                }
                const product = await srv
                    .tx(req)
                    .run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                if (!product) {
                    throw new Error(`Product with ID ${orderItem.product_ID} not found`);
                }
                if (product.stockQuantity < orderItem.quantity) {
                    throw new Error(`Not enough stock available for product ${product.name}. Requested: ${orderItem.quantity}, Available: ${product.stockQuantity}`);
                }
                const itemTotalPrice = product.price * orderItem.quantity;
                totalOrderAmount += itemTotalPrice;
                return {
                    original: orderItem,
                    product: product,
                    unitPrice: product.price,
                    totalPrice: itemTotalPrice,
                };
            });
            const validatedItems = await Promise.all(productPromises);
            for (const item of validatedItems) {
                await srv.tx(req).run(UPDATE.entity(Products)
                    .where({ ID: item.original.product_ID })
                    .set({
                    stockQuantity: { "-=": item.original.quantity },
                }));
                item.original.unitPrice = item.unitPrice;
                item.original.totalPrice = item.totalPrice;
            }
            req.data.totalAmount = totalOrderAmount;
        }
        catch (error) {
            req.error(400, error.message);
            return;
        }
    });
    srv.before("UPDATE", Orders, async (req) => {
        if (req.data.items && req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        for (let key in req.data) {
            if (req.data[key] === null ||
                req.data[key] === undefined ||
                req.data[key] === "") {
                req.error(400, `${key} cannot be null or undefined or empty`);
                return;
            }
        }
        if (req.data.items) {
            let totalOrderAmount = 0;
            try {
                const product = await srv.tx(req).run(SELECT.one.from(Products).where({ ID: req.data.items[0].product_ID }));
                if (!product) {
                    throw new Error(`Product with ID ${req.data.items[0].product_ID} not found`);
                }
                if (product.stockQuantity < req.data.items[0].quantity) {
                    throw new Error(`Not enough stock available for product ${product.name}. Requested: ${req.data.items[0].quantity}, Available: ${product.stockQuantity}`);
                }
                const itemTotalPrice = product.price * req.data.items[0].quantity;
                totalOrderAmount = itemTotalPrice;
                await srv.tx(req).run(UPDATE.entity(Products)
                    .where({ ID: req.data.items[0].product_ID })
                    .set({
                    stockQuantity: { "-=": req.data.items[0].quantity },
                }));
                req.data.items[0].unitPrice = product.price;
                req.data.items[0].totalPrice = itemTotalPrice;
                req.data.totalAmount = totalOrderAmount;
            }
            catch (error) {
                req.error(400, error.message);
                return;
            }
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsNEJBa0tDO0FBcktELG1EQUEyQjtBQUMzQixNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQUcsQ0FBQyxFQUFFLENBQUM7QUFFbkIsS0FBSyxvQkFBVyxHQUFHO0lBQ2hDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDckQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsRUFBRTtRQUNwRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDakUsR0FBRyxDQUFDLEtBQUssQ0FDUCxHQUFHLEVBQ0gsa0dBQWtHLENBQ25HLENBQUM7WUFDRixPQUFPO1FBQ1QsQ0FBQztRQUNELE1BQU0sZUFBZSxHQUFHLE1BQU0sR0FBRzthQUM5QixFQUFFLENBQUMsR0FBRyxDQUFDO2FBQ1AsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNqRSxJQUFJLGVBQWUsRUFBRSxDQUFDO1lBQ3BCLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLHFCQUFxQixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksaUJBQWlCLENBQUMsQ0FBQztZQUNwRSxPQUFPO1FBQ1QsQ0FBQztJ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R0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUM7cUJBQzNDLEdBQUcsQ0FBQztvQkFDSCxhQUFhLEVBQUUsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFO2lCQUNwRCxDQUFDLENBQ0wsQ0FBQztnQkFDRixHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztnQkFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxHQUFHLGNBQWMsQ0FBQztnQkFDOUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsZ0JBQWdCLENBQUM7WUFDMUMsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUM5QixPQUFPO1lBQ1QsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2RzIGZyb20gXCJAc2FwL2Nkc1wiO1xyXG5jb25zdCB7IFNFTEVDVCwgVVBEQVRFIH0gPSBjZHMucWw7XHJcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tIFwiQHNhcC9jZHNcIjtcclxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gKHNydikge1xyXG4gIGNvbnN0IHsgT3JkZXJzLCBQcm9kdWN0cywgQ3VzdG9tZXJzIH0gPSBzcnYuZW50aXRpZXM7XHJcbiAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBQcm9kdWN0cywgYXN5bmMgKHJlcTogUmVxdWVzdCkgPT4ge1xyXG4gICAgaWYgKCFyZXEuZGF0YS5uYW1lIHx8ICFyZXEuZGF0YS5wcmljZSB8fCAhcmVxLmRhdGEuc3RvY2tRdWFudGl0eSkge1xyXG4gICAgICByZXEuZXJyb3IoXHJcbiAgICAgICAgNDAwLFxyXG4gICAgICAgIFwiTmFtZSwgcHJpY2UsIGFuZCBzdG9jayBxdWFudGl0eSBhcmUgcmVxdWlyZWQsIGlmIHRoZXkgZXhpc3QgdGhlaXIgdmFsdWUgc2hvdWxkIGJlIGdyZWF0ZXIgdGhhbiAwXCJcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZXhpc3RpbmdQcm9kdWN0ID0gYXdhaXQgc3J2XHJcbiAgICAgIC50eChyZXEpXHJcbiAgICAgIC5ydW4oU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IG5hbWU6IHJlcS5kYXRhLm5hbWUgfSkpO1xyXG4gICAgaWYgKGV4aXN0aW5nUHJvZHVjdCkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBgUHJvZHVjdCB3aXRoIG5hbWUgJHtyZXEuZGF0YS5uYW1lfSBhbHJlYWR5IGV4aXN0c2ApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG4gIHNydi5iZWZvcmUoXCJDUkVBVEVcIiwgQ3VzdG9tZXJzLCBhc3luYyAocmVxOiBSZXF1ZXN0KSA9PiB7XHJcbiAgICBpZiAoIXJlcS5kYXRhLmZpcnN0TmFtZSB8fCAhcmVxLmRhdGEuZW1haWwgfHwgIXJlcS5kYXRhLmxhc3ROYW1lKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDAsIFwiTmFtZSBhbmQgZW1haWwgYXJlIHJlcXVpcmVkXCIpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBleGlzdGluZ0N1c3RvbWVyID0gYXdhaXQgc3J2XHJcbiAgICAgIC50eChyZXEpXHJcbiAgICAgIC5ydW4oU0VMRUNULm9uZS5mcm9tKEN1c3RvbWVycykud2hlcmUoeyBlbWFpbDogcmVxLmRhdGEuZW1haWwgfSkpO1xyXG4gICAgaWYgKGV4aXN0aW5nQ3VzdG9tZXIpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgYEN1c3RvbWVyIHdpdGggZW1haWwgJHtyZXEuZGF0YS5lbWFpbH0gYWxyZWFkeSBleGlzdHNgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBzcnYuYmVmb3JlKFwiQ1JFQVRFXCIsIE9yZGVycywgYXN5bmMgKHJlcTogUmVxdWVzdCkgPT4ge1xyXG4gICAgaWYgKCFyZXEuZGF0YS5jdXN0b21lcl9JRCkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBcIkN1c3RvbWVyIElEIGlzIHJlcXVpcmVkXCIpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY3VzdG9tZXIgPSBhd2FpdCBzcnZcclxuICAgICAgLnR4KHJlcSlcclxuICAgICAgLnJ1bihTRUxFQ1Qub25lLmZyb20oQ3VzdG9tZXJzKS53aGVyZSh7IElEOiByZXEuZGF0YS5jdXN0b21lcl9JRCB9KSk7XHJcblxyXG4gICAgaWYgKCFjdXN0b21lcikge1xyXG4gICAgICByZXEuZXJyb3IoNDA0LCBgQ3VzdG9tZXIgd2l0aCBJRCAke3JlcS5kYXRhLmN1c3RvbWVyX0lEfSBub3QgZm91bmRgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChcclxuICAgICAgIXJlcS5kYXRhLml0ZW1zIHx8XHJcbiAgICAgICFBcnJheS5pc0FycmF5KHJlcS5kYXRhLml0ZW1zKSB8fFxyXG4gICAgICByZXEuZGF0YS5pdGVtcy5sZW5ndGggPT09IDBcclxuICAgICkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBcIk9yZGVyIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgaXRlbVwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCB0b3RhbE9yZGVyQW1vdW50ID0gMDtcclxuICAgIGNvbnN0IHByb2Nlc3NlZEl0ZW1zID0gW107XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgcHJvZHVjdFByb21pc2VzID0gcmVxLmRhdGEuaXRlbXMubWFwKGFzeW5jIChvcmRlckl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghb3JkZXJJdGVtLnByb2R1Y3RfSUQgfHwgIW9yZGVySXRlbS5xdWFudGl0eSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICBcIlByb2R1Y3QgSUQgYW5kIHF1YW50aXR5IGFyZSByZXF1aXJlZCBmb3IgYWxsIG9yZGVyIGl0ZW1zXCJcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgc3J2XHJcbiAgICAgICAgICAudHgocmVxKVxyXG4gICAgICAgICAgLnJ1bihTRUxFQ1Qub25lLmZyb20oUHJvZHVjdHMpLndoZXJlKHsgSUQ6IG9yZGVySXRlbS5wcm9kdWN0X0lEIH0pKTtcclxuXHJcbiAgICAgICAgaWYgKCFwcm9kdWN0KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb2R1Y3Qgd2l0aCBJRCAke29yZGVySXRlbS5wcm9kdWN0X0lEfSBub3QgZm91bmRgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChwcm9kdWN0LnN0b2NrUXVhbnRpdHkgPCBvcmRlckl0ZW0ucXVhbnRpdHkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgYE5vdCBlbm91Z2ggc3RvY2sgYXZhaWxhYmxlIGZvciBwcm9kdWN0ICR7cHJvZHVjdC5uYW1lfS4gUmVxdWVzdGVkOiAke29yZGVySXRlbS5xdWFudGl0eX0sIEF2YWlsYWJsZTogJHtwcm9kdWN0LnN0b2NrUXVhbnRpdHl9YFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW1Ub3RhbFByaWNlID0gcHJvZHVjdC5wcmljZSAqIG9yZGVySXRlbS5xdWFudGl0eTtcclxuICAgICAgICB0b3RhbE9yZGVyQW1vdW50ICs9IGl0ZW1Ub3RhbFByaWNlO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgb3JpZ2luYWw6IG9yZGVySXRlbSxcclxuICAgICAgICAgIHByb2R1Y3Q6IHByb2R1Y3QsXHJcbiAgICAgICAgICB1bml0UHJpY2U6IHByb2R1Y3QucHJpY2UsXHJcbiAgICAgICAgICB0b3RhbFByaWNlOiBpdGVtVG90YWxQcmljZSxcclxuICAgICAgICB9O1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHZhbGlkYXRlZEl0ZW1zID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvZHVjdFByb21pc2VzKTtcclxuXHJcbiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWxpZGF0ZWRJdGVtcykge1xyXG4gICAgICAgIGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICAgIFVQREFURS5lbnRpdHkoUHJvZHVjdHMpXHJcbiAgICAgICAgICAgIC53aGVyZSh7IElEOiBpdGVtLm9yaWdpbmFsLnByb2R1Y3RfSUQgfSlcclxuICAgICAgICAgICAgLnNldCh7XHJcbiAgICAgICAgICAgICAgc3RvY2tRdWFudGl0eTogeyBcIi09XCI6IGl0ZW0ub3JpZ2luYWwucXVhbnRpdHkgfSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBpdGVtLm9yaWdpbmFsLnVuaXRQcmljZSA9IGl0ZW0udW5pdFByaWNlO1xyXG4gICAgICAgIGl0ZW0ub3JpZ2luYWwudG90YWxQcmljZSA9IGl0ZW0udG90YWxQcmljZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmVxLmRhdGEudG90YWxBbW91bnQgPSB0b3RhbE9yZGVyQW1vdW50O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgc3J2LmJlZm9yZShcIlVQREFURVwiLCBPcmRlcnMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmIChyZXEuZGF0YS5pdGVtcyAmJiByZXEuZGF0YS5pdGVtcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgXCJPcmRlciBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGl0ZW1cIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGZvciAobGV0IGtleSBpbiByZXEuZGF0YSkge1xyXG4gICAgICBpZiAoXHJcbiAgICAgICAgcmVxLmRhdGFba2V5XSA9PT0gbnVsbCB8fFxyXG4gICAgICAgIHJlcS5kYXRhW2tleV0gPT09IHVuZGVmaW5lZCB8fFxyXG4gICAgICAgIHJlcS5kYXRhW2tleV0gPT09IFwiXCJcclxuICAgICAgKSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgYCR7a2V5fSBjYW5ub3QgYmUgbnVsbCBvciB1bmRlZmluZWQgb3IgZW1wdHlgKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAocmVxLmRhdGEuaXRlbXMpIHtcclxuICAgICAgbGV0IHRvdGFsT3JkZXJBbW91bnQgPSAwO1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICBTRUxFQ1Qub25lLmZyb20oUHJvZHVjdHMpLndoZXJlKHsgSUQ6IHJlcS5kYXRhLml0ZW1zWzBdLnByb2R1Y3RfSUQgfSlcclxuICAgICAgICkgXHJcbiAgICAgICBpZighcHJvZHVjdCl7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQcm9kdWN0IHdpdGggSUQgJHtyZXEuZGF0YS5pdGVtc1swXS5wcm9kdWN0X0lEfSBub3QgZm91bmRgKTtcclxuICAgICAgIH1cclxuICAgICAgICBpZihwcm9kdWN0LnN0b2NrUXVhbnRpdHkgPCByZXEuZGF0YS5pdGVtc1swXS5xdWFudGl0eSl7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBlbm91Z2ggc3RvY2sgYXZhaWxhYmxlIGZvciBwcm9kdWN0ICR7cHJvZHVjdC5uYW1lfS4gUmVxdWVzdGVkOiAke3JlcS5kYXRhLml0ZW1zWzBdLnF1YW50aXR5fSwgQXZhaWxhYmxlOiAke3Byb2R1Y3Quc3RvY2tRdWFudGl0eX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaXRlbVRvdGFsUHJpY2UgPSBwcm9kdWN0LnByaWNlICogcmVxLmRhdGEuaXRlbXNbMF0ucXVhbnRpdHk7XHJcbiAgICAgICAgdG90YWxPcmRlckFtb3VudCA9IGl0ZW1Ub3RhbFByaWNlO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICAgIFVQREFURS5lbnRpdHkoUHJvZHVjdHMpXHJcbiAgICAgICAgICAgIC53aGVyZSh7IElEOiByZXEuZGF0YS5pdGVtc1swXS5wcm9kdWN0X0lEIH0pXHJcbiAgICAgICAgICAgIC5zZXQoe1xyXG4gICAgICAgICAgICAgIHN0b2NrUXVhbnRpdHk6IHsgXCItPVwiOiByZXEuZGF0YS5pdGVtc1swXS5xdWFudGl0eSB9LFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgcmVxLmRhdGEuaXRlbXNbMF0udW5pdFByaWNlID0gcHJvZHVjdC5wcmljZTtcclxuICAgICAgICByZXEuZGF0YS5pdGVtc1swXS50b3RhbFByaWNlID0gaXRlbVRvdGFsUHJpY2U7XHJcbiAgICAgICAgcmVxLmRhdGEudG90YWxBbW91bnQgPSB0b3RhbE9yZGVyQW1vdW50O1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcbiJdfQ==