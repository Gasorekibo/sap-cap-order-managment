"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
const cds_1 = __importDefault(require("@sap/cds"));
const { SELECT, UPDATE } = cds_1.default.ql;
async function default_1(srv) {
    console.log("========================================");
    console.log("ORDER MANAGEMENT SERVICE IS INITIALIZING");
    console.log("========================================");
    const { Orders, Products, Customers } = srv.entities;
    srv.before("CREATE", Products, async (req) => {
        if (!req.data.name || !req.data.price || !req.data.stockQuantity) {
            req.error(400, "Name, price, and stock quantity are required, if they exist their value should be greater than 0");
            return;
        }
        const existingProduct = await srv.tx(req).run(SELECT.one.from(Products).where({ name: req.data.name }));
        if (existingProduct) {
            req.error(400, `Product with name ${req.data.name} already exists`);
            return;
        }
    });
    srv.before("CREATE", Customers, async (req) => {
        if (!req.data.firstName || !req.data.email || !req.data.lastName) {
            req.error(400, "Name and email are required");
            return;
        }
        const existingCustomer = await srv.tx(req).run(SELECT.one.from(Customers).where({ email: req.data.email }));
        if (existingCustomer) {
            req.error(400, `Customer with email ${req.data.email} already exists`);
            return;
        }
    });
    srv.before("CREATE", Orders, async (req) => {
        if (!req.data.customer_ID) {
            req.error(400, "Customer ID is required");
            return;
        }
        const customer = await srv.tx(req).run(SELECT.one.from(Customers).where({ ID: req.data.customer_ID }));
        if (!customer) {
            req.error(404, `Customer with ID ${req.data.customer_ID} not found`);
            return;
        }
        if (!req.data.items || !Array.isArray(req.data.items) || req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        let totalOrderAmount = 0;
        const processedItems = [];
        try {
            const productPromises = req.data.items.map(async (orderItem) => {
                if (!orderItem.product_ID || !orderItem.quantity) {
                    throw new Error("Product ID and quantity are required for all order items");
                }
                const product = await srv.tx(req).run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                if (!product) {
                    throw new Error(`Product with ID ${orderItem.product_ID} not found`);
                }
                if (product.stockQuantity < orderItem.quantity) {
                    throw new Error(`Not enough stock available for product ${product.name}. Requested: ${orderItem.quantity}, Available: ${product.stockQuantity}`);
                }
                const itemTotalPrice = product.price * orderItem.quantity;
                totalOrderAmount += itemTotalPrice;
                return {
                    original: orderItem,
                    product: product,
                    unitPrice: product.price,
                    totalPrice: itemTotalPrice
                };
            });
            const validatedItems = await Promise.all(productPromises);
            for (const item of validatedItems) {
                // Update product stock
                await srv.tx(req).run(UPDATE(Products)
                    .where({ ID: item.original.product_ID })
                    .set({
                    stockQuantity: { "-=": item.original.quantity }
                }));
                item.original.unitPrice = item.unitPrice;
                item.original.totalPrice = item.totalPrice;
            }
            req.data.totalAmount = totalOrderAmount;
        }
        catch (error) {
            req.error(400, error.message);
            return;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsNEJBK0dDO0FBbEhELG1EQUEyQjtBQUMzQixNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQUcsQ0FBQyxFQUFFLENBQUM7QUFFbkIsS0FBSyxvQkFBVyxHQUFHO0lBRS9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsMENBQTBDLENBQUMsQ0FBQztJQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFDeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0lBR3hELE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDckQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFXLEVBQUUsRUFBRTtRQUNsRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDakUsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsa0dBQWtHLENBQUMsQ0FBQztZQUNuSCxPQUFPO1FBQ1QsQ0FBQztRQUNELE1BQU0sZUFBZSxHQUFHLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQzNDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQ3pELENBQUM7UUFD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LEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztxQkFDdkMsR0FBRyxDQUFDO29CQUNILGFBQWEsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRTtpQkFDaEQsQ0FBQyxDQUNMLENBQUM7Z0JBRUYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDekMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUM3QyxDQUFDO1lBRUQsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsZ0JBQWdCLENBQUM7UUFDMUMsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDOUIsT0FBTztRQUNULENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2RzIGZyb20gJ0BzYXAvY2RzJztcclxuY29uc3QgeyBTRUxFQ1QsIFVQREFURSB9ID0gY2RzLnFsO1xyXG5pbXBvcnQge1JlcXVlc3R9IGZyb20gJ0BzYXAvY2RzJ1xyXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoc3J2KSB7XHJcblxyXG4gICBjb25zb2xlLmxvZyhcIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cIik7XHJcbiAgIGNvbnNvbGUubG9nKFwiT1JERVIgTUFOQUdFTUVOVCBTRVJWSUNFIElTIElOSVRJQUxJWklOR1wiKTtcclxuICAgY29uc29sZS5sb2coXCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XCIpO1xyXG4gICBcclxuICBcclxuICAgY29uc3QgeyBPcmRlcnMsIFByb2R1Y3RzLCBDdXN0b21lcnMgfSA9IHNydi5lbnRpdGllcztcclxuICAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBQcm9kdWN0cywgYXN5bmMgKHJlcTpSZXF1ZXN0KSA9PiB7XHJcbiAgICAgIGlmICghcmVxLmRhdGEubmFtZSB8fCAhcmVxLmRhdGEucHJpY2UgfHwgIXJlcS5kYXRhLnN0b2NrUXVhbnRpdHkpIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBcIk5hbWUsIHByaWNlLCBhbmQgc3RvY2sgcXVhbnRpdHkgYXJlIHJlcXVpcmVkLCBpZiB0aGV5IGV4aXN0IHRoZWlyIHZhbHVlIHNob3VsZCBiZSBncmVhdGVyIHRoYW4gMFwiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgZXhpc3RpbmdQcm9kdWN0ID0gYXdhaXQgc3J2LnR4KHJlcSkucnVuKFxyXG4gICAgICAgIFNFTEVDVC5vbmUuZnJvbShQcm9kdWN0cykud2hlcmUoeyBuYW1lOiByZXEuZGF0YS5uYW1lIH0pXHJcbiAgICAgICk7XHJcbiAgICAgIGlmIChleGlzdGluZ1Byb2R1Y3QpIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBgUHJvZHVjdCB3aXRoIG5hbWUgJHtyZXEuZGF0YS5uYW1lfSBhbHJlYWR5IGV4aXN0c2ApO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgfSlcclxuXHJcbiAgIHNydi5iZWZvcmUoXCJDUkVBVEVcIiwgQ3VzdG9tZXJzLCBhc3luYyAocmVxOlJlcXVlc3QpID0+IHtcclxuICAgICAgaWYgKCFyZXEuZGF0YS5maXJzdE5hbWUgfHwgIXJlcS5kYXRhLmVtYWlsIHx8ICFyZXEuZGF0YS5sYXN0TmFtZSkge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIFwiTmFtZSBhbmQgZW1haWwgYXJlIHJlcXVpcmVkXCIpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBleGlzdGluZ0N1c3RvbWVyID0gYXdhaXQgc3J2LnR4KHJlcSkucnVuKFxyXG4gICAgICAgIFNFTEVDVC5vbmUuZnJvbShDdXN0b21lcnMpLndoZXJlKHsgZW1haWw6IHJlcS5kYXRhLmVtYWlsIH0pXHJcbiAgICAgICk7XHJcbiAgICAgIGlmIChleGlzdGluZ0N1c3RvbWVyKSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgYEN1c3RvbWVyIHdpdGggZW1haWwgJHtyZXEuZGF0YS5lbWFpbH0gYWxyZWFkeSBleGlzdHNgKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgfSlcclxuXHJcbiAgIHNydi5iZWZvcmUoXCJDUkVBVEVcIiwgT3JkZXJzLCBhc3luYyAocmVxOiBSZXF1ZXN0KSA9PiB7XHJcbiAgICBpZiAoIXJlcS5kYXRhLmN1c3RvbWVyX0lEKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDAsIFwiQ3VzdG9tZXIgSUQgaXMgcmVxdWlyZWRcIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29uc3QgY3VzdG9tZXIgPSBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgIFNFTEVDVC5vbmUuZnJvbShDdXN0b21lcnMpLndoZXJlKHsgSUQ6IHJlcS5kYXRhLmN1c3RvbWVyX0lEIH0pXHJcbiAgICApO1xyXG4gICAgXHJcbiAgICBpZiAoIWN1c3RvbWVyKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDQsIGBDdXN0b21lciB3aXRoIElEICR7cmVxLmRhdGEuY3VzdG9tZXJfSUR9IG5vdCBmb3VuZGApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgXHJcbiAgICBpZiAoIXJlcS5kYXRhLml0ZW1zIHx8ICFBcnJheS5pc0FycmF5KHJlcS5kYXRhLml0ZW1zKSB8fCByZXEuZGF0YS5pdGVtcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgXCJPcmRlciBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGl0ZW1cIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICBcclxuICAgIGxldCB0b3RhbE9yZGVyQW1vdW50ID0gMDtcclxuICAgIGNvbnN0IHByb2Nlc3NlZEl0ZW1zID0gW107XHJcbiAgXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBwcm9kdWN0UHJvbWlzZXMgPSByZXEuZGF0YS5pdGVtcy5tYXAoYXN5bmMgKG9yZGVySXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKCFvcmRlckl0ZW0ucHJvZHVjdF9JRCB8fCAhb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQcm9kdWN0IElEIGFuZCBxdWFudGl0eSBhcmUgcmVxdWlyZWQgZm9yIGFsbCBvcmRlciBpdGVtc1wiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICAgIFNFTEVDVC5vbmUuZnJvbShQcm9kdWN0cykud2hlcmUoeyBJRDogb3JkZXJJdGVtLnByb2R1Y3RfSUQgfSlcclxuICAgICAgICApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghcHJvZHVjdCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQcm9kdWN0IHdpdGggSUQgJHtvcmRlckl0ZW0ucHJvZHVjdF9JRH0gbm90IGZvdW5kYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmIChwcm9kdWN0LnN0b2NrUXVhbnRpdHkgPCBvcmRlckl0ZW0ucXVhbnRpdHkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgTm90IGVub3VnaCBzdG9jayBhdmFpbGFibGUgZm9yIHByb2R1Y3QgJHtwcm9kdWN0Lm5hbWV9LiBSZXF1ZXN0ZWQ6ICR7b3JkZXJJdGVtLnF1YW50aXR5fSwgQXZhaWxhYmxlOiAke3Byb2R1Y3Quc3RvY2tRdWFudGl0eX1gKTtcclxuICAgICAgICB9XHJcbiAgXHJcbiAgICAgICAgY29uc3QgaXRlbVRvdGFsUHJpY2UgPSBwcm9kdWN0LnByaWNlICogb3JkZXJJdGVtLnF1YW50aXR5O1xyXG4gICAgICAgIHRvdGFsT3JkZXJBbW91bnQgKz0gaXRlbVRvdGFsUHJpY2U7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIG9yaWdpbmFsOiBvcmRlckl0ZW0sXHJcbiAgICAgICAgICBwcm9kdWN0OiBwcm9kdWN0LFxyXG4gICAgICAgICAgdW5pdFByaWNlOiBwcm9kdWN0LnByaWNlLFxyXG4gICAgICAgICAgdG90YWxQcmljZTogaXRlbVRvdGFsUHJpY2VcclxuICAgICAgICB9O1xyXG4gICAgICB9KTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHZhbGlkYXRlZEl0ZW1zID0gYXdhaXQgUHJvbWlzZS5hbGwocHJvZHVjdFByb21pc2VzKTtcclxuICAgICAgXHJcbiAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWxpZGF0ZWRJdGVtcykge1xyXG4gICAgICAgIC8vIFVwZGF0ZSBwcm9kdWN0IHN0b2NrXHJcbiAgICAgICAgYXdhaXQgc3J2LnR4KHJlcSkucnVuKFxyXG4gICAgICAgICAgVVBEQVRFKFByb2R1Y3RzKVxyXG4gICAgICAgICAgICAud2hlcmUoeyBJRDogaXRlbS5vcmlnaW5hbC5wcm9kdWN0X0lEIH0pXHJcbiAgICAgICAgICAgIC5zZXQoe1xyXG4gICAgICAgICAgICAgIHN0b2NrUXVhbnRpdHk6IHsgXCItPVwiOiBpdGVtLm9yaWdpbmFsLnF1YW50aXR5IH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gIFxyXG4gICAgICAgIGl0ZW0ub3JpZ2luYWwudW5pdFByaWNlID0gaXRlbS51bml0UHJpY2U7XHJcbiAgICAgICAgaXRlbS5vcmlnaW5hbC50b3RhbFByaWNlID0gaXRlbS50b3RhbFByaWNlO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICByZXEuZGF0YS50b3RhbEFtb3VudCA9IHRvdGFsT3JkZXJBbW91bnQ7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcblxyXG4iXX0=