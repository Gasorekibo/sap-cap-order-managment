"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
async function default_1(srv) {
    console.log("========================================");
    console.log("ORDER MANAGEMENT SERVICE IS INITIALIZING");
    console.log("========================================");
    const { Orders, OrderItems, Products, Customers } = srv.entities;
    srv.before("CREATE", Products, async (req) => {
        if (!req.data.name || !req.data.price || !req.data.stockQuantity) {
            req.error(400, "Name, price, and stock quantity are required");
            return;
        }
        if (req.data.price < 0) {
            req.error(400, "Price cannot be negative");
            return;
        }
        if (req.data.stockQuantity < 0) {
            req.error(400, "Stock quantity cannot be negative");
            return;
        }
        const existingProduct = await srv.tx(req).run(SELECT.one.from(Products).where({ name: req.data.name }));
        if (existingProduct) {
            req.error(400, `Product with name ${req.data.name} already exists`);
            return;
        }
    });
    srv.before("CREATE", Customers, async (req) => {
        if (!req.data.firstName || !req.data.email || !req.data.lastName) {
            req.error(400, "Name and email are required");
            return;
        }
        const existingCustomer = await srv.tx(req).run(SELECT.one.from(Customers).where({ email: req.data.email }));
        if (existingCustomer) {
            req.error(400, `Customer with email ${req.data.email} already exists`);
            return;
        }
    });
    srv.before("CREATE", Orders, async (req) => {
        if (!req.data.customer_ID) {
            req.error(400, "Customer ID is required");
            return;
        }
        const customer = await srv.tx(req).run(SELECT.one.from(Customers).where({ ID: req.data.customer_ID }));
        if (!customer) {
            req.error(404, `Customer with ID ${req.data.customer_ID} not found`);
            return;
        }
        if (!req.data.items || !Array.isArray(req.data.items) || req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        let totalOrderAmount = 0;
        const processedItems = [];
        try {
            const productPromises = req.data.items.map(async (orderItem) => {
                if (!orderItem.product_ID || !orderItem.quantity) {
                    throw new Error("Product ID and quantity are required for all order items");
                }
                const product = await srv.tx(req).run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                if (!product) {
                    throw new Error(`Product with ID ${orderItem.product_ID} not found`);
                }
                if (product.stockQuantity < orderItem.quantity) {
                    throw new Error(`Not enough stock available for product ${product.name}. Requested: ${orderItem.quantity}, Available: ${product.stockQuantity}`);
                }
                const itemTotalPrice = product.price * orderItem.quantity;
                totalOrderAmount += itemTotalPrice;
                return {
                    original: orderItem,
                    product: product,
                    unitPrice: product.price,
                    totalPrice: itemTotalPrice
                };
            });
            const validatedItems = await Promise.all(productPromises);
            for (const item of validatedItems) {
                // Update product stock
                await srv.tx(req).run(UPDATE(Products)
                    .where({ ID: item.original.product_ID })
                    .set({
                    stockQuantity: { "-=": item.original.quantity }
                }));
                item.original.unitPrice = item.unitPrice;
                item.original.totalPrice = item.totalPrice;
            }
            req.data.totalAmount = totalOrderAmount;
        }
        catch (error) {
            req.error(400, error.message);
            return;
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBRUEsNEJBdUhDO0FBdkhjLEtBQUssb0JBQVcsR0FBRztJQUUvQixPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFDeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0lBQ3hELE9BQU8sQ0FBQyxHQUFHLENBQUMsMENBQTBDLENBQUMsQ0FBQztJQUd4RCxNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQztJQUNqRSxHQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEdBQVcsRUFBRSxFQUFFO1FBQ2xELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNqRSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSw4Q0FBOEMsQ0FBQyxDQUFDO1lBQy9ELE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN2QixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSwwQkFBMEIsQ0FBQyxDQUFDO1lBQzNDLE9BQU87UUFDVCxDQUFDO1FBQ0QsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUMvQixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxtQ0FBbUMsQ0FBQyxDQUFDO1lBQ3BELE9BQU87UUFDVCxDQUFD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QU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7WUFFMUQsS0FBSyxNQUFNLElBQUksSUFBSSxjQUFjLEVBQUUsQ0FBQztnQkFDbEMsdUJBQXVCO2dCQUN2QixNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUNuQixNQUFNLENBQUMsUUFBUSxDQUFDO3FCQUNiLEtBQUssQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO3FCQUN2QyxHQUFHLENBQUM7b0JBQ0gsYUFBYSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFO2lCQUNoRCxDQUFDLENBQ0wsQ0FBQztnQkFFRixJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUN6QyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1lBQzdDLENBQUM7WUFFRCxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQztRQUMxQyxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM5QixPQUFPO1FBQ1QsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQge1JlcXVlc3R9IGZyb20gJ0BzYXAvY2RzJ1xyXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoc3J2KSB7XHJcblxyXG4gICBjb25zb2xlLmxvZyhcIj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cIik7XHJcbiAgIGNvbnNvbGUubG9nKFwiT1JERVIgTUFOQUdFTUVOVCBTRVJWSUNFIElTIElOSVRJQUxJWklOR1wiKTtcclxuICAgY29uc29sZS5sb2coXCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XCIpO1xyXG4gICBcclxuICBcclxuICAgY29uc3QgeyBPcmRlcnMsIE9yZGVySXRlbXMsIFByb2R1Y3RzLCBDdXN0b21lcnMgfSA9IHNydi5lbnRpdGllcztcclxuICAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBQcm9kdWN0cywgYXN5bmMgKHJlcTpSZXF1ZXN0KSA9PiB7XHJcbiAgICAgIGlmICghcmVxLmRhdGEubmFtZSB8fCAhcmVxLmRhdGEucHJpY2UgfHwgIXJlcS5kYXRhLnN0b2NrUXVhbnRpdHkpIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBcIk5hbWUsIHByaWNlLCBhbmQgc3RvY2sgcXVhbnRpdHkgYXJlIHJlcXVpcmVkXCIpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBpZiAocmVxLmRhdGEucHJpY2UgPCAwKSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgXCJQcmljZSBjYW5ub3QgYmUgbmVnYXRpdmVcIik7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChyZXEuZGF0YS5zdG9ja1F1YW50aXR5IDwgMCkge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIFwiU3RvY2sgcXVhbnRpdHkgY2Fubm90IGJlIG5lZ2F0aXZlXCIpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBleGlzdGluZ1Byb2R1Y3QgPSBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgICAgU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IG5hbWU6IHJlcS5kYXRhLm5hbWUgfSlcclxuICAgICAgKTtcclxuICAgICAgaWYgKGV4aXN0aW5nUHJvZHVjdCkge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIGBQcm9kdWN0IHdpdGggbmFtZSAke3JlcS5kYXRhLm5hbWV9IGFscmVhZHkgZXhpc3RzYCk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICB9KVxyXG5cclxuICAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBDdXN0b21lcnMsIGFzeW5jIChyZXE6UmVxdWVzdCkgPT4ge1xyXG4gICAgICBpZiAoIXJlcS5kYXRhLmZpcnN0TmFtZSB8fCAhcmVxLmRhdGEuZW1haWwgfHwgIXJlcS5kYXRhLmxhc3ROYW1lKSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgXCJOYW1lIGFuZCBlbWFpbCBhcmUgcmVxdWlyZWRcIik7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nQ3VzdG9tZXIgPSBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgICAgU0VMRUNULm9uZS5mcm9tKEN1c3RvbWVycykud2hlcmUoeyBlbWFpbDogcmVxLmRhdGEuZW1haWwgfSlcclxuICAgICAgKTtcclxuICAgICAgaWYgKGV4aXN0aW5nQ3VzdG9tZXIpIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBgQ3VzdG9tZXIgd2l0aCBlbWFpbCAke3JlcS5kYXRhLmVtYWlsfSBhbHJlYWR5IGV4aXN0c2ApO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICB9KVxyXG5cclxuICAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBPcmRlcnMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmICghcmVxLmRhdGEuY3VzdG9tZXJfSUQpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgXCJDdXN0b21lciBJRCBpcyByZXF1aXJlZFwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCBjdXN0b21lciA9IGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgU0VMRUNULm9uZS5mcm9tKEN1c3RvbWVycykud2hlcmUoeyBJRDogcmVxLmRhdGEuY3VzdG9tZXJfSUQgfSlcclxuICAgICk7XHJcbiAgICBcclxuICAgIGlmICghY3VzdG9tZXIpIHtcclxuICAgICAgcmVxLmVycm9yKDQwNCwgYEN1c3RvbWVyIHdpdGggSUQgJHtyZXEuZGF0YS5jdXN0b21lcl9JRH0gbm90IGZvdW5kYCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICBcclxuICAgIGlmICghcmVxLmRhdGEuaXRlbXMgfHwgIUFycmF5LmlzQXJyYXkocmVxLmRhdGEuaXRlbXMpIHx8IHJlcS5kYXRhLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBcIk9yZGVyIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgaXRlbVwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgbGV0IHRvdGFsT3JkZXJBbW91bnQgPSAwO1xyXG4gICAgY29uc3QgcHJvY2Vzc2VkSXRlbXMgPSBbXTtcclxuICBcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHByb2R1Y3RQcm9taXNlcyA9IHJlcS5kYXRhLml0ZW1zLm1hcChhc3luYyAob3JkZXJJdGVtOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoIW9yZGVySXRlbS5wcm9kdWN0X0lEIHx8ICFvcmRlckl0ZW0ucXVhbnRpdHkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlByb2R1Y3QgSUQgYW5kIHF1YW50aXR5IGFyZSByZXF1aXJlZCBmb3IgYWxsIG9yZGVyIGl0ZW1zXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgc3J2LnR4KHJlcSkucnVuKFxyXG4gICAgICAgICAgU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IElEOiBvcmRlckl0ZW0ucHJvZHVjdF9JRCB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCFwcm9kdWN0KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb2R1Y3Qgd2l0aCBJRCAke29yZGVySXRlbS5wcm9kdWN0X0lEfSBub3QgZm91bmRgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKHByb2R1Y3Quc3RvY2tRdWFudGl0eSA8IG9yZGVySXRlbS5xdWFudGl0eSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3QgZW5vdWdoIHN0b2NrIGF2YWlsYWJsZSBmb3IgcHJvZHVjdCAke3Byb2R1Y3QubmFtZX0uIFJlcXVlc3RlZDogJHtvcmRlckl0ZW0ucXVhbnRpdHl9LCBBdmFpbGFibGU6ICR7cHJvZHVjdC5zdG9ja1F1YW50aXR5fWApO1xyXG4gICAgICAgIH1cclxuICBcclxuICAgICAgICBjb25zdCBpdGVtVG90YWxQcmljZSA9IHByb2R1Y3QucHJpY2UgKiBvcmRlckl0ZW0ucXVhbnRpdHk7XHJcbiAgICAgICAgdG90YWxPcmRlckFtb3VudCArPSBpdGVtVG90YWxQcmljZTtcclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgb3JpZ2luYWw6IG9yZGVySXRlbSxcclxuICAgICAgICAgIHByb2R1Y3Q6IHByb2R1Y3QsXHJcbiAgICAgICAgICB1bml0UHJpY2U6IHByb2R1Y3QucHJpY2UsXHJcbiAgICAgICAgICB0b3RhbFByaWNlOiBpdGVtVG90YWxQcmljZVxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG4gICAgICBcclxuICAgICAgY29uc3QgdmFsaWRhdGVkSXRlbXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9kdWN0UHJvbWlzZXMpO1xyXG4gICAgICBcclxuICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbGlkYXRlZEl0ZW1zKSB7XHJcbiAgICAgICAgLy8gVXBkYXRlIHByb2R1Y3Qgc3RvY2tcclxuICAgICAgICBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgICAgICBVUERBVEUoUHJvZHVjdHMpXHJcbiAgICAgICAgICAgIC53aGVyZSh7IElEOiBpdGVtLm9yaWdpbmFsLnByb2R1Y3RfSUQgfSlcclxuICAgICAgICAgICAgLnNldCh7XHJcbiAgICAgICAgICAgICAgc3RvY2tRdWFudGl0eTogeyBcIi09XCI6IGl0ZW0ub3JpZ2luYWwucXVhbnRpdHkgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgXHJcbiAgICAgICAgaXRlbS5vcmlnaW5hbC51bml0UHJpY2UgPSBpdGVtLnVuaXRQcmljZTtcclxuICAgICAgICBpdGVtLm9yaWdpbmFsLnRvdGFsUHJpY2UgPSBpdGVtLnRvdGFsUHJpY2U7XHJcbiAgICAgIH1cclxuICAgICAgXHJcbiAgICAgIHJlcS5kYXRhLnRvdGFsQW1vdW50ID0gdG90YWxPcmRlckFtb3VudDtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDAsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbiJdfQ==