"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
const cds_1 = __importDefault(require("@sap/cds"));
const { SELECT, UPDATE } = cds_1.default.ql;
async function default_1(srv) {
    console.log("========================================");
    console.log("ORDER MANAGEMENT SERVICE IS INITIALIZING");
    console.log("========================================");
    const { Orders, Products, Customers } = srv.entities;
    srv.before("CREATE", Products, async (req) => {
        if (!req.data.name || !req.data.price || !req.data.stockQuantity) {
            req.error(400, "Name, price, and stock quantity are required, if they exist their value should be greater than 0");
            return;
        }
        const existingProduct = await srv
            .tx(req)
            .run(SELECT.one.from(Products).where({ name: req.data.name }));
        if (existingProduct) {
            req.error(400, `Product with name ${req.data.name} already exists`);
            return;
        }
    });
    srv.before("CREATE", Customers, async (req) => {
        if (!req.data.firstName || !req.data.email || !req.data.lastName) {
            req.error(400, "Name and email are required");
            return;
        }
        const existingCustomer = await srv
            .tx(req)
            .run(SELECT.one.from(Customers).where({ email: req.data.email }));
        if (existingCustomer) {
            req.error(400, `Customer with email ${req.data.email} already exists`);
            return;
        }
    });
    srv.before("CREATE", Orders, async (req) => {
        if (!req.data.customer_ID) {
            req.error(400, "Customer ID is required");
            return;
        }
        const customer = await srv
            .tx(req)
            .run(SELECT.one.from(Customers).where({ ID: req.data.customer_ID }));
        if (!customer) {
            req.error(404, `Customer with ID ${req.data.customer_ID} not found`);
            return;
        }
        if (!req.data.items ||
            !Array.isArray(req.data.items) ||
            req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        let totalOrderAmount = 0;
        const processedItems = [];
        try {
            const productPromises = req.data.items.map(async (orderItem) => {
                if (!orderItem.product_ID || !orderItem.quantity) {
                    throw new Error("Product ID and quantity are required for all order items");
                }
                const product = await srv
                    .tx(req)
                    .run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                if (!product) {
                    throw new Error(`Product with ID ${orderItem.product_ID} not found`);
                }
                if (product.stockQuantity < orderItem.quantity) {
                    throw new Error(`Not enough stock available for product ${product.name}. Requested: ${orderItem.quantity}, Available: ${product.stockQuantity}`);
                }
                const itemTotalPrice = product.price * orderItem.quantity;
                totalOrderAmount += itemTotalPrice;
                return {
                    original: orderItem,
                    product: product,
                    unitPrice: product.price,
                    totalPrice: itemTotalPrice,
                };
            });
            const validatedItems = await Promise.all(productPromises);
            for (const item of validatedItems) {
                // Update product stock
                await srv.tx(req).run(UPDATE.entity(Products)
                    .where({ ID: item.original.product_ID })
                    .set({
                    stockQuantity: { "-=": item.original.quantity },
                }));
                item.original.unitPrice = item.unitPrice;
                item.original.totalPrice = item.totalPrice;
            }
            req.data.totalAmount = totalOrderAmount;
        }
        catch (error) {
            req.error(400, error.message);
            return;
        }
    });
    srv.before("UPDATE", Orders, async (req) => {
        if (req.data.items && req.data.items.length === 0) {
            req.error(400, "Order must contain at least one item");
            return;
        }
        for (let key in req.data) {
            if (req.data[key] === null ||
                req.data[key] === undefined ||
                req.data[key] === "") {
                req.error(400, `${key} cannot be null or undefined or empty`);
                return;
            }
        }
        if (req.data.items) {
            let totalOrderAmount = 0;
            const processedItems = [];
            try {
                const productPromises = req.data.items.map(async (orderItem) => {
                    if (!orderItem.product_ID || !orderItem.quantity) {
                        throw new Error("Product ID and quantity are required for all order items");
                    }
                    const product = await srv
                        .tx(req)
                        .run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                    if (!product) {
                        throw new Error(`Product with ID ${orderItem.product_ID} not found`);
                    }
                    if (product.stockQuantity < orderItem.quantity) {
                        throw new Error(`Not enough stock available for product ${product.name}. Requested: ${orderItem.quantity}, Available: ${product.stockQuantity}`);
                    }
                    const itemTotalPrice = product.price * orderItem.quantity;
                    totalOrderAmount += itemTotalPrice;
                    return {
                        original: orderItem,
                        product: product,
                        unitPrice: product.price,
                        totalPrice: itemTotalPrice,
                    };
                });
                const validatedItems = await Promise.all(productPromises);
                for (const item of validatedItems) {
                    // Update product stock
                    await srv.tx(req).run(UPDATE.entity(Products)
                        .where({ ID: item.original.product_ID })
                        .set({
                        stockQuantity: { "-=": item.original.quantity },
                    }));
                    item.original.unitPrice = item.unitPrice;
                    item.original.totalPrice = item.totalPrice;
                }
                req.data.totalAmount = totalOrderAmount;
            }
            catch (error) {
                req.error(400, error.message);
                return;
            }
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsNEJBdU1DO0FBMU1ELG1EQUEyQjtBQUMzQixNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQUcsQ0FBQyxFQUFFLENBQUM7QUFFbkIsS0FBSyxvQkFBVyxHQUFHO0lBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsMENBQTBDLENBQUMsQ0FBQztJQUN4RCxPQUFPLENBQUMsR0FBRyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFDeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO0lBRXhELE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDckQsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsRUFBRTtRQUNwRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDakUsR0FBRyxDQUFDLEtBQUssQ0FDUCxHQUFHLEVBQ0gsa0dBQWtHLENBQ25HLENBQUM7WUFDRixPQUFPO1FBQ1QsQ0FBQztRQUNELE1BQU0sZUFBZSxHQUFHLE1BQU0sR0FBRzthQUM5QixFQUFFLENBQUMsR0FBRyxDQUFDO2FBQ1AsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNq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LENBQUM7SUFDSCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2RzIGZyb20gXCJAc2FwL2Nkc1wiO1xyXG5jb25zdCB7IFNFTEVDVCwgVVBEQVRFIH0gPSBjZHMucWw7XHJcbmltcG9ydCB7IFJlcXVlc3QgfSBmcm9tIFwiQHNhcC9jZHNcIjtcclxuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gKHNydikge1xyXG4gIGNvbnNvbGUubG9nKFwiPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVwiKTtcclxuICBjb25zb2xlLmxvZyhcIk9SREVSIE1BTkFHRU1FTlQgU0VSVklDRSBJUyBJTklUSUFMSVpJTkdcIik7XHJcbiAgY29uc29sZS5sb2coXCI9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XCIpO1xyXG5cclxuICBjb25zdCB7IE9yZGVycywgUHJvZHVjdHMsIEN1c3RvbWVycyB9ID0gc3J2LmVudGl0aWVzO1xyXG4gIHNydi5iZWZvcmUoXCJDUkVBVEVcIiwgUHJvZHVjdHMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmICghcmVxLmRhdGEubmFtZSB8fCAhcmVxLmRhdGEucHJpY2UgfHwgIXJlcS5kYXRhLnN0b2NrUXVhbnRpdHkpIHtcclxuICAgICAgcmVxLmVycm9yKFxyXG4gICAgICAgIDQwMCxcclxuICAgICAgICBcIk5hbWUsIHByaWNlLCBhbmQgc3RvY2sgcXVhbnRpdHkgYXJlIHJlcXVpcmVkLCBpZiB0aGV5IGV4aXN0IHRoZWlyIHZhbHVlIHNob3VsZCBiZSBncmVhdGVyIHRoYW4gMFwiXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGV4aXN0aW5nUHJvZHVjdCA9IGF3YWl0IHNydlxyXG4gICAgICAudHgocmVxKVxyXG4gICAgICAucnVuKFNFTEVDVC5vbmUuZnJvbShQcm9kdWN0cykud2hlcmUoeyBuYW1lOiByZXEuZGF0YS5uYW1lIH0pKTtcclxuICAgIGlmIChleGlzdGluZ1Byb2R1Y3QpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgYFByb2R1Y3Qgd2l0aCBuYW1lICR7cmVxLmRhdGEubmFtZX0gYWxyZWFkeSBleGlzdHNgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBzcnYuYmVmb3JlKFwiQ1JFQVRFXCIsIEN1c3RvbWVycywgYXN5bmMgKHJlcTogUmVxdWVzdCkgPT4ge1xyXG4gICAgaWYgKCFyZXEuZGF0YS5maXJzdE5hbWUgfHwgIXJlcS5kYXRhLmVtYWlsIHx8ICFyZXEuZGF0YS5sYXN0TmFtZSkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBcIk5hbWUgYW5kIGVtYWlsIGFyZSByZXF1aXJlZFwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZXhpc3RpbmdDdXN0b21lciA9IGF3YWl0IHNydlxyXG4gICAgICAudHgocmVxKVxyXG4gICAgICAucnVuKFNFTEVDVC5vbmUuZnJvbShDdXN0b21lcnMpLndoZXJlKHsgZW1haWw6IHJlcS5kYXRhLmVtYWlsIH0pKTtcclxuICAgIGlmIChleGlzdGluZ0N1c3RvbWVyKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDAsIGBDdXN0b21lciB3aXRoIGVtYWlsICR7cmVxLmRhdGEuZW1haWx9IGFscmVhZHkgZXhpc3RzYCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBPcmRlcnMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmICghcmVxLmRhdGEuY3VzdG9tZXJfSUQpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgXCJDdXN0b21lciBJRCBpcyByZXF1aXJlZFwiKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGN1c3RvbWVyID0gYXdhaXQgc3J2XHJcbiAgICAgIC50eChyZXEpXHJcbiAgICAgIC5ydW4oU0VMRUNULm9uZS5mcm9tKEN1c3RvbWVycykud2hlcmUoeyBJRDogcmVxLmRhdGEuY3VzdG9tZXJfSUQgfSkpO1xyXG5cclxuICAgIGlmICghY3VzdG9tZXIpIHtcclxuICAgICAgcmVxLmVycm9yKDQwNCwgYEN1c3RvbWVyIHdpdGggSUQgJHtyZXEuZGF0YS5jdXN0b21lcl9JRH0gbm90IGZvdW5kYCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoXHJcbiAgICAgICFyZXEuZGF0YS5pdGVtcyB8fFxyXG4gICAgICAhQXJyYXkuaXNBcnJheShyZXEuZGF0YS5pdGVtcykgfHxcclxuICAgICAgcmVxLmRhdGEuaXRlbXMubGVuZ3RoID09PSAwXHJcbiAgICApIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgXCJPcmRlciBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGl0ZW1cIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgdG90YWxPcmRlckFtb3VudCA9IDA7XHJcbiAgICBjb25zdCBwcm9jZXNzZWRJdGVtcyA9IFtdO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHByb2R1Y3RQcm9taXNlcyA9IHJlcS5kYXRhLml0ZW1zLm1hcChhc3luYyAob3JkZXJJdGVtOiBhbnkpID0+IHtcclxuICAgICAgICBpZiAoIW9yZGVySXRlbS5wcm9kdWN0X0lEIHx8ICFvcmRlckl0ZW0ucXVhbnRpdHkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgXCJQcm9kdWN0IElEIGFuZCBxdWFudGl0eSBhcmUgcmVxdWlyZWQgZm9yIGFsbCBvcmRlciBpdGVtc1wiXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHNydlxyXG4gICAgICAgICAgLnR4KHJlcSlcclxuICAgICAgICAgIC5ydW4oU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IElEOiBvcmRlckl0ZW0ucHJvZHVjdF9JRCB9KSk7XHJcblxyXG4gICAgICAgIGlmICghcHJvZHVjdCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQcm9kdWN0IHdpdGggSUQgJHtvcmRlckl0ZW0ucHJvZHVjdF9JRH0gbm90IGZvdW5kYCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocHJvZHVjdC5zdG9ja1F1YW50aXR5IDwgb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgIGBOb3QgZW5vdWdoIHN0b2NrIGF2YWlsYWJsZSBmb3IgcHJvZHVjdCAke3Byb2R1Y3QubmFtZX0uIFJlcXVlc3RlZDogJHtvcmRlckl0ZW0ucXVhbnRpdHl9LCBBdmFpbGFibGU6ICR7cHJvZHVjdC5zdG9ja1F1YW50aXR5fWBcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpdGVtVG90YWxQcmljZSA9IHByb2R1Y3QucHJpY2UgKiBvcmRlckl0ZW0ucXVhbnRpdHk7XHJcbiAgICAgICAgdG90YWxPcmRlckFtb3VudCArPSBpdGVtVG90YWxQcmljZTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIG9yaWdpbmFsOiBvcmRlckl0ZW0sXHJcbiAgICAgICAgICBwcm9kdWN0OiBwcm9kdWN0LFxyXG4gICAgICAgICAgdW5pdFByaWNlOiBwcm9kdWN0LnByaWNlLFxyXG4gICAgICAgICAgdG90YWxQcmljZTogaXRlbVRvdGFsUHJpY2UsXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCB2YWxpZGF0ZWRJdGVtcyA9IGF3YWl0IFByb21pc2UuYWxsKHByb2R1Y3RQcm9taXNlcyk7XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsaWRhdGVkSXRlbXMpIHtcclxuICAgICAgICAvLyBVcGRhdGUgcHJvZHVjdCBzdG9ja1xyXG4gICAgICAgIGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICAgIFVQREFURS5lbnRpdHkoUHJvZHVjdHMpXHJcbiAgICAgICAgICAgIC53aGVyZSh7IElEOiBpdGVtLm9yaWdpbmFsLnByb2R1Y3RfSUQgfSlcclxuICAgICAgICAgICAgLnNldCh7XHJcbiAgICAgICAgICAgICAgc3RvY2tRdWFudGl0eTogeyBcIi09XCI6IGl0ZW0ub3JpZ2luYWwucXVhbnRpdHkgfSxcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBpdGVtLm9yaWdpbmFsLnVuaXRQcmljZSA9IGl0ZW0udW5pdFByaWNlO1xyXG4gICAgICAgIGl0ZW0ub3JpZ2luYWwudG90YWxQcmljZSA9IGl0ZW0udG90YWxQcmljZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmVxLmRhdGEudG90YWxBbW91bnQgPSB0b3RhbE9yZGVyQW1vdW50O1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgZXJyb3IubWVzc2FnZSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgc3J2LmJlZm9yZShcIlVQREFURVwiLCBPcmRlcnMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmIChyZXEuZGF0YS5pdGVtcyAmJiByZXEuZGF0YS5pdGVtcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgXCJPcmRlciBtdXN0IGNvbnRhaW4gYXQgbGVhc3Qgb25lIGl0ZW1cIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGZvciAobGV0IGtleSBpbiByZXEuZGF0YSkge1xyXG4gICAgICBpZiAoXHJcbiAgICAgICAgcmVxLmRhdGFba2V5XSA9PT0gbnVsbCB8fFxyXG4gICAgICAgIHJlcS5kYXRhW2tleV0gPT09IHVuZGVmaW5lZCB8fFxyXG4gICAgICAgIHJlcS5kYXRhW2tleV0gPT09IFwiXCJcclxuICAgICAgKSB7XHJcbiAgICAgICAgcmVxLmVycm9yKDQwMCwgYCR7a2V5fSBjYW5ub3QgYmUgbnVsbCBvciB1bmRlZmluZWQgb3IgZW1wdHlgKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgaWYgKHJlcS5kYXRhLml0ZW1zKSB7XHJcbiAgICAgIGxldCB0b3RhbE9yZGVyQW1vdW50ID0gMDtcclxuICAgICAgY29uc3QgcHJvY2Vzc2VkSXRlbXMgPSBbXTtcclxuXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgcHJvZHVjdFByb21pc2VzID0gcmVxLmRhdGEuaXRlbXMubWFwKGFzeW5jIChvcmRlckl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFvcmRlckl0ZW0ucHJvZHVjdF9JRCB8fCAhb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgICBcIlByb2R1Y3QgSUQgYW5kIHF1YW50aXR5IGFyZSByZXF1aXJlZCBmb3IgYWxsIG9yZGVyIGl0ZW1zXCJcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBjb25zdCBwcm9kdWN0ID0gYXdhaXQgc3J2XHJcbiAgICAgICAgICAgIC50eChyZXEpXHJcbiAgICAgICAgICAgIC5ydW4oU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IElEOiBvcmRlckl0ZW0ucHJvZHVjdF9JRCB9KSk7XHJcblxyXG4gICAgICAgICAgaWYgKCFwcm9kdWN0KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgICBgUHJvZHVjdCB3aXRoIElEICR7b3JkZXJJdGVtLnByb2R1Y3RfSUR9IG5vdCBmb3VuZGBcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBpZiAocHJvZHVjdC5zdG9ja1F1YW50aXR5IDwgb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgICBgTm90IGVub3VnaCBzdG9jayBhdmFpbGFibGUgZm9yIHByb2R1Y3QgJHtwcm9kdWN0Lm5hbWV9LiBSZXF1ZXN0ZWQ6ICR7b3JkZXJJdGVtLnF1YW50aXR5fSwgQXZhaWxhYmxlOiAke3Byb2R1Y3Quc3RvY2tRdWFudGl0eX1gXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgY29uc3QgaXRlbVRvdGFsUHJpY2UgPSBwcm9kdWN0LnByaWNlICogb3JkZXJJdGVtLnF1YW50aXR5O1xyXG4gICAgICAgICAgdG90YWxPcmRlckFtb3VudCArPSBpdGVtVG90YWxQcmljZTtcclxuXHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBvcmlnaW5hbDogb3JkZXJJdGVtLFxyXG4gICAgICAgICAgICBwcm9kdWN0OiBwcm9kdWN0LFxyXG4gICAgICAgICAgICB1bml0UHJpY2U6IHByb2R1Y3QucHJpY2UsXHJcbiAgICAgICAgICAgIHRvdGFsUHJpY2U6IGl0ZW1Ub3RhbFByaWNlLFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdmFsaWRhdGVkSXRlbXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9kdWN0UHJvbWlzZXMpO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsaWRhdGVkSXRlbXMpIHtcclxuICAgICAgICAgIC8vIFVwZGF0ZSBwcm9kdWN0IHN0b2NrXHJcbiAgICAgICAgICBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgICAgICAgIFVQREFURS5lbnRpdHkoUHJvZHVjdHMpXHJcbiAgICAgICAgICAgICAgLndoZXJlKHsgSUQ6IGl0ZW0ub3JpZ2luYWwucHJvZHVjdF9JRCB9KVxyXG4gICAgICAgICAgICAgIC5zZXQoe1xyXG4gICAgICAgICAgICAgICAgc3RvY2tRdWFudGl0eTogeyBcIi09XCI6IGl0ZW0ub3JpZ2luYWwucXVhbnRpdHkgfSxcclxuICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICBpdGVtLm9yaWdpbmFsLnVuaXRQcmljZSA9IGl0ZW0udW5pdFByaWNlO1xyXG4gICAgICAgICAgaXRlbS5vcmlnaW5hbC50b3RhbFByaWNlID0gaXRlbS50b3RhbFByaWNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVxLmRhdGEudG90YWxBbW91bnQgPSB0b3RhbE9yZGVyQW1vdW50O1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcbiJdfQ==