"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = default_1;
const cds_1 = __importDefault(require("@sap/cds"));
const { SELECT, UPDATE } = cds_1.default.ql;
async function default_1(srv) {
    const { Orders, Products, Customers } = srv.entities;
    const i18n = cds_1.default.i18n.labels;
    srv.before("CREATE", Products, async (req) => {
        if (!req.data.name || !req.data.price || !req.data.stockQuantity) {
            req.error(400, i18n.at('product.required'));
            return;
        }
        const existingProduct = await srv
            .tx(req)
            .run(SELECT.one.from(Products).where({ name: req.data.name }));
        if (existingProduct) {
            req.error(400, i18n.at('product.exists', [req.data.name]));
            return;
        }
    });
    srv.before("CREATE", Customers, async (req) => {
        if (!req.data.firstName || !req.data.email || !req.data.lastName) {
            req.error(400, i18n.at('customer.required'));
            return;
        }
        const existingCustomer = await srv
            .tx(req)
            .run(SELECT.one.from(Customers).where({ email: req.data.email }));
        if (existingCustomer) {
            req.error(400, i18n.at('customer.exists', [req.data.email]));
            return;
        }
    });
    srv.before("CREATE", Orders, async (req) => {
        if (!req.data.customer_ID) {
            req.error(400, i18n.at('order.customer.required'));
            return;
        }
        const customer = await srv
            .tx(req)
            .run(SELECT.one.from(Customers).where({ ID: req.data.customer_ID }));
        if (!customer) {
            req.error(404, i18n.at('order.customer.notfound', [req.data.customer_ID]));
            return;
        }
        if (!req.data.items ||
            !Array.isArray(req.data.items) ||
            req.data.items.length === 0) {
            req.error(400, i18n.at('order.items.required'));
            return;
        }
        let totalOrderAmount = 0;
        const processedItems = [];
        try {
            const productPromises = req.data.items.map(async (orderItem) => {
                if (!orderItem.product_ID || !orderItem.quantity) {
                    throw new Error(i18n.at('order.item.details.required'));
                }
                const product = await srv
                    .tx(req)
                    .run(SELECT.one.from(Products).where({ ID: orderItem.product_ID }));
                if (!product) {
                    throw new Error(i18n.at('order.product.notfound', [orderItem.product_ID]));
                }
                if (product.stockQuantity < orderItem.quantity) {
                    throw new Error(i18n.at('order.insufficient.stock', {
                        product: product.name,
                        requested: orderItem.quantity,
                        available: product.stockQuantity,
                    }));
                }
                const itemTotalPrice = product.price * orderItem.quantity;
                totalOrderAmount += itemTotalPrice;
                return {
                    original: orderItem,
                    product: product,
                    unitPrice: product.price,
                    totalPrice: itemTotalPrice,
                };
            });
            const validatedItems = await Promise.all(productPromises);
            for (const item of validatedItems) {
                await srv.tx(req).run(UPDATE.entity(Products)
                    .where({ ID: item.original.product_ID })
                    .set({
                    stockQuantity: { "-=": item.original.quantity },
                }));
                item.original.unitPrice = item.unitPrice;
                item.original.totalPrice = item.totalPrice;
            }
            req.data.totalAmount = totalOrderAmount;
        }
        catch (error) {
            req.error(400, error.message);
            return;
        }
    });
    srv.before("UPDATE", Orders, async (req) => {
        if (req.data.items && req.data.items.length === 0) {
            req.error(400, i18n.at('update.order.without.items'));
            return;
        }
        for (let key in req.data) {
            if (req.data[key] === null ||
                req.data[key] === undefined ||
                req.data[key] === "") {
                req.error(400, i18n.at('update.null.error', [key]));
                return;
            }
        }
        if (req.data.items) {
            let totalOrderAmount = 0;
            try {
                const product = await srv.tx(req).run(SELECT.one.from(Products).where({ ID: req.data.items[0].product_ID }));
                if (!product) {
                    throw new Error(i18n.at('order.product.notfound', [req.data.items[0].product_ID]));
                }
                if (product.stockQuantity < req.data.items[0].quantity) {
                    throw new Error(i18n.at('update.insufficient.stock', [
                        product.name,
                        req.data.items[0].quantity,
                        product.stockQuantity,
                    ]));
                }
                const itemTotalPrice = product.price * req.data.items[0].quantity;
                totalOrderAmount = itemTotalPrice;
                await srv.tx(req).run(UPDATE.entity(Products)
                    .where({ ID: req.data.items[0].product_ID })
                    .set({
                    stockQuantity: { "-=": req.data.items[0].quantity },
                }));
                req.data.items[0].unitPrice = product.price;
                req.data.items[0].totalPrice = itemTotalPrice;
                req.data.totalAmount = totalOrderAmount;
            }
            catch (error) {
                req.error(400, error.message);
                return;
            }
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib3JkZXItbWFuYWdlbWVudC1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsNEJBMEtDO0FBN0tELG1EQUF1QztBQUN2QyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLGFBQUcsQ0FBQyxFQUFFLENBQUM7QUFFbkIsS0FBSyxvQkFBVyxHQUFHO0lBQ2hDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUM7SUFDckQsTUFBTSxJQUFJLEdBQUksYUFBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUE7SUFDN0IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFZLEVBQUUsRUFBRTtRQUNwRCxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDakUsR0FBRyxDQUFDLEtBQUssQ0FDUCxHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUNqQyxDQUFDO1lBQ0YsT0FBTztRQUNULENBQUM7UUFDRCxNQUFNLGVBQWUsR0FBRyxNQUFNLEdBQUc7YUFDOUIsRUFBRSxDQUFDLEdBQUcsQ0FBQzthQUNQLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakUsSUFBSSxlQUFlLEVBQUUsQ0FBQztZQUNwQixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcs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QUMxQyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzlCLE9BQU87WUFDVCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjZHMsIHsgdXBkYXRlIH0gZnJvbSBcIkBzYXAvY2RzXCI7XHJcbmNvbnN0IHsgU0VMRUNULCBVUERBVEUgfSA9IGNkcy5xbDtcclxuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gXCJAc2FwL2Nkc1wiO1xyXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoc3J2KSB7XHJcbiAgY29uc3QgeyBPcmRlcnMsIFByb2R1Y3RzLCBDdXN0b21lcnMgfSA9IHNydi5lbnRpdGllcztcclxuICBjb25zdCBpMThuID0gIGNkcy5pMThuLmxhYmVsc1xyXG4gIHNydi5iZWZvcmUoXCJDUkVBVEVcIiwgUHJvZHVjdHMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmICghcmVxLmRhdGEubmFtZSB8fCAhcmVxLmRhdGEucHJpY2UgfHwgIXJlcS5kYXRhLnN0b2NrUXVhbnRpdHkpIHtcclxuICAgICAgcmVxLmVycm9yKFxyXG4gICAgICAgIDQwMCwgaTE4bi5hdCgncHJvZHVjdC5yZXF1aXJlZCcpXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGV4aXN0aW5nUHJvZHVjdCA9IGF3YWl0IHNydlxyXG4gICAgICAudHgocmVxKVxyXG4gICAgICAucnVuKFNFTEVDVC5vbmUuZnJvbShQcm9kdWN0cykud2hlcmUoeyBuYW1lOiByZXEuZGF0YS5uYW1lIH0pKTtcclxuICAgIGlmIChleGlzdGluZ1Byb2R1Y3QpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgaTE4bi5hdCgncHJvZHVjdC5leGlzdHMnLCBbcmVxLmRhdGEubmFtZSBdKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBDdXN0b21lcnMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmICghcmVxLmRhdGEuZmlyc3ROYW1lIHx8ICFyZXEuZGF0YS5lbWFpbCB8fCAhcmVxLmRhdGEubGFzdE5hbWUpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgaTE4bi5hdCgnY3VzdG9tZXIucmVxdWlyZWQnKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGV4aXN0aW5nQ3VzdG9tZXIgPSBhd2FpdCBzcnZcclxuICAgICAgLnR4KHJlcSlcclxuICAgICAgLnJ1bihTRUxFQ1Qub25lLmZyb20oQ3VzdG9tZXJzKS53aGVyZSh7IGVtYWlsOiByZXEuZGF0YS5lbWFpbCB9KSk7XHJcbiAgICBpZiAoZXhpc3RpbmdDdXN0b21lcikge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBpMThuLmF0KCdjdXN0b21lci5leGlzdHMnLCBbcmVxLmRhdGEuZW1haWxdKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgc3J2LmJlZm9yZShcIkNSRUFURVwiLCBPcmRlcnMsIGFzeW5jIChyZXE6IFJlcXVlc3QpID0+IHtcclxuICAgIGlmICghcmVxLmRhdGEuY3VzdG9tZXJfSUQpIHtcclxuICAgICAgcmVxLmVycm9yKDQwMCwgaTE4bi5hdCgnb3JkZXIuY3VzdG9tZXIucmVxdWlyZWQnKSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjdXN0b21lciA9IGF3YWl0IHNydlxyXG4gICAgICAudHgocmVxKVxyXG4gICAgICAucnVuKFNFTEVDVC5vbmUuZnJvbShDdXN0b21lcnMpLndoZXJlKHsgSUQ6IHJlcS5kYXRhLmN1c3RvbWVyX0lEIH0pKTtcclxuXHJcbiAgICBpZiAoIWN1c3RvbWVyKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDQsIGkxOG4uYXQoJ29yZGVyLmN1c3RvbWVyLm5vdGZvdW5kJywgW3JlcS5kYXRhLmN1c3RvbWVyX0lEXSkpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKFxyXG4gICAgICAhcmVxLmRhdGEuaXRlbXMgfHxcclxuICAgICAgIUFycmF5LmlzQXJyYXkocmVxLmRhdGEuaXRlbXMpIHx8XHJcbiAgICAgIHJlcS5kYXRhLml0ZW1zLmxlbmd0aCA9PT0gMFxyXG4gICAgKSB7XHJcbiAgICAgIHJlcS5lcnJvcig0MDAsIGkxOG4uYXQoJ29yZGVyLml0ZW1zLnJlcXVpcmVkJykpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHRvdGFsT3JkZXJBbW91bnQgPSAwO1xyXG4gICAgY29uc3QgcHJvY2Vzc2VkSXRlbXMgPSBbXTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBwcm9kdWN0UHJvbWlzZXMgPSByZXEuZGF0YS5pdGVtcy5tYXAoYXN5bmMgKG9yZGVySXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKCFvcmRlckl0ZW0ucHJvZHVjdF9JRCB8fCAhb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgIGkxOG4uYXQoJ29yZGVyLml0ZW0uZGV0YWlscy5yZXF1aXJlZCcpXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcHJvZHVjdCA9IGF3YWl0IHNydlxyXG4gICAgICAgICAgLnR4KHJlcSlcclxuICAgICAgICAgIC5ydW4oU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IElEOiBvcmRlckl0ZW0ucHJvZHVjdF9JRCB9KSk7XHJcblxyXG4gICAgICAgIGlmICghcHJvZHVjdCkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkxOG4uYXQoJ29yZGVyLnByb2R1Y3Qubm90Zm91bmQnLCBbb3JkZXJJdGVtLnByb2R1Y3RfSURdKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocHJvZHVjdC5zdG9ja1F1YW50aXR5IDwgb3JkZXJJdGVtLnF1YW50aXR5KSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgIGkxOG4uYXQoJ29yZGVyLmluc3VmZmljaWVudC5zdG9jaycsIHtcclxuICAgICAgICAgICAgICBwcm9kdWN0OiBwcm9kdWN0Lm5hbWUsXHJcbiAgICAgICAgICAgICAgcmVxdWVzdGVkOiBvcmRlckl0ZW0ucXVhbnRpdHksXHJcbiAgICAgICAgICAgICAgYXZhaWxhYmxlOiBwcm9kdWN0LnN0b2NrUXVhbnRpdHksXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXRlbVRvdGFsUHJpY2UgPSBwcm9kdWN0LnByaWNlICogb3JkZXJJdGVtLnF1YW50aXR5O1xyXG4gICAgICAgIHRvdGFsT3JkZXJBbW91bnQgKz0gaXRlbVRvdGFsUHJpY2U7XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBvcmlnaW5hbDogb3JkZXJJdGVtLFxyXG4gICAgICAgICAgcHJvZHVjdDogcHJvZHVjdCxcclxuICAgICAgICAgIHVuaXRQcmljZTogcHJvZHVjdC5wcmljZSxcclxuICAgICAgICAgIHRvdGFsUHJpY2U6IGl0ZW1Ub3RhbFByaWNlLFxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgdmFsaWRhdGVkSXRlbXMgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9kdWN0UHJvbWlzZXMpO1xyXG5cclxuICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbGlkYXRlZEl0ZW1zKSB7XHJcbiAgICAgICAgYXdhaXQgc3J2LnR4KHJlcSkucnVuKFxyXG4gICAgICAgICAgVVBEQVRFLmVudGl0eShQcm9kdWN0cylcclxuICAgICAgICAgICAgLndoZXJlKHsgSUQ6IGl0ZW0ub3JpZ2luYWwucHJvZHVjdF9JRCB9KVxyXG4gICAgICAgICAgICAuc2V0KHtcclxuICAgICAgICAgICAgICBzdG9ja1F1YW50aXR5OiB7IFwiLT1cIjogaXRlbS5vcmlnaW5hbC5xdWFudGl0eSB9LFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGl0ZW0ub3JpZ2luYWwudW5pdFByaWNlID0gaXRlbS51bml0UHJpY2U7XHJcbiAgICAgICAgaXRlbS5vcmlnaW5hbC50b3RhbFByaWNlID0gaXRlbS50b3RhbFByaWNlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXEuZGF0YS50b3RhbEFtb3VudCA9IHRvdGFsT3JkZXJBbW91bnQ7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICBzcnYuYmVmb3JlKFwiVVBEQVRFXCIsIE9yZGVycywgYXN5bmMgKHJlcTogUmVxdWVzdCkgPT4ge1xyXG4gICAgaWYgKHJlcS5kYXRhLml0ZW1zICYmIHJlcS5kYXRhLml0ZW1zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXEuZXJyb3IoNDAwLCBpMThuLmF0KCd1cGRhdGUub3JkZXIud2l0aG91dC5pdGVtcycpKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZm9yIChsZXQga2V5IGluIHJlcS5kYXRhKSB7XHJcbiAgICAgIGlmIChcclxuICAgICAgICByZXEuZGF0YVtrZXldID09PSBudWxsIHx8XHJcbiAgICAgICAgcmVxLmRhdGFba2V5XSA9PT0gdW5kZWZpbmVkIHx8XHJcbiAgICAgICAgcmVxLmRhdGFba2V5XSA9PT0gXCJcIlxyXG4gICAgICApIHtcclxuICAgICAgICByZXEuZXJyb3IoNDAwLCBpMThuLmF0KCd1cGRhdGUubnVsbC5lcnJvcicsIFtrZXldKSk7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHJlcS5kYXRhLml0ZW1zKSB7XHJcbiAgICAgIGxldCB0b3RhbE9yZGVyQW1vdW50ID0gMDtcclxuICAgICAgdHJ5IHtcclxuICAgICAgIGNvbnN0IHByb2R1Y3QgPSBhd2FpdCBzcnYudHgocmVxKS5ydW4oXHJcbiAgICAgICAgU0VMRUNULm9uZS5mcm9tKFByb2R1Y3RzKS53aGVyZSh7IElEOiByZXEuZGF0YS5pdGVtc1swXS5wcm9kdWN0X0lEIH0pXHJcbiAgICAgICApIFxyXG4gICAgICAgaWYoIXByb2R1Y3Qpe1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihpMThuLmF0KCdvcmRlci5wcm9kdWN0Lm5vdGZvdW5kJywgW3JlcS5kYXRhLml0ZW1zWzBdLnByb2R1Y3RfSURdKSk7XHJcbiAgICAgICB9XHJcbiAgICAgICAgaWYocHJvZHVjdC5zdG9ja1F1YW50aXR5IDwgcmVxLmRhdGEuaXRlbXNbMF0ucXVhbnRpdHkpe1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGkxOG4uYXQoJ3VwZGF0ZS5pbnN1ZmZpY2llbnQuc3RvY2snLCBbXHJcbiAgICAgICAgICAgIHByb2R1Y3QubmFtZSxcclxuICAgICAgICAgICAgcmVxLmRhdGEuaXRlbXNbMF0ucXVhbnRpdHksXHJcbiAgICAgICAgICAgIHByb2R1Y3Quc3RvY2tRdWFudGl0eSxcclxuICAgICAgICAgIF0pKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaXRlbVRvdGFsUHJpY2UgPSBwcm9kdWN0LnByaWNlICogcmVxLmRhdGEuaXRlbXNbMF0ucXVhbnRpdHk7XHJcbiAgICAgICAgdG90YWxPcmRlckFtb3VudCA9IGl0ZW1Ub3RhbFByaWNlO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGF3YWl0IHNydi50eChyZXEpLnJ1bihcclxuICAgICAgICAgIFVQREFURS5lbnRpdHkoUHJvZHVjdHMpXHJcbiAgICAgICAgICAgIC53aGVyZSh7IElEOiByZXEuZGF0YS5pdGVtc1swXS5wcm9kdWN0X0lEIH0pXHJcbiAgICAgICAgICAgIC5zZXQoe1xyXG4gICAgICAgICAgICAgIHN0b2NrUXVhbnRpdHk6IHsgXCItPVwiOiByZXEuZGF0YS5pdGVtc1swXS5xdWFudGl0eSB9LFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgcmVxLmRhdGEuaXRlbXNbMF0udW5pdFByaWNlID0gcHJvZHVjdC5wcmljZTtcclxuICAgICAgICByZXEuZGF0YS5pdGVtc1swXS50b3RhbFByaWNlID0gaXRlbVRvdGFsUHJpY2U7XHJcbiAgICAgICAgcmVxLmRhdGEudG90YWxBbW91bnQgPSB0b3RhbE9yZGVyQW1vdW50O1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJlcS5lcnJvcig0MDAsIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcbiJdfQ==